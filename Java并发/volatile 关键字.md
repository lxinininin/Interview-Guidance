## volatile 关键字

`volatile` 是 Java 中的一个关键字，用于修饰变量。它主要用于保证变量的可见性和禁止指令重排序，但并不能保证原子性。

### 可见性

当一个变量被声明为 `volatile` 时，线程在修改该变量的值后，会<u>立即将该变量的最新值写回到主内存中，并且当其他线程需要读取该变量时，会从主内存中重新获取最新的值，而不是使用线程自己的缓存</u>。这样可以确保所有线程看到的都是同一个最新的值，从而保证了变量的可见性。

<img src="assets/jmm.png" alt="jmm" style="zoom:67%;" />

<img src="assets/jmm2.png" alt="jmm2" style="zoom:67%;" />

### 禁止指令重排序

`volatile` 关键字还可以禁止编译器和处理器对被修饰变量进行指令重排序，保证了一定的有序性。<u>当程序执行到 volatile 变量的读操作或者写操作时, 在其前面的操作的更改肯定全部已经进行, 且结果已经对后面的操作可见; 在其后面的操作肯定还没有进行</u>; 这对于一些特定的多线程场景非常重要，比如双重检查锁定模式中使用 `volatile` 来确保线程安全。

```java
x = 2;  // 语句1
y = 0;  // 语句2
flag = true;  // 语句3
x = 4;  // 语句4
y = -1;  // 语句5
```

由于 flag 变量为 volatile 变量, 那么在进行指令重排序的过程中, 不会将语句 3 放到语句1, 2 前面, 也不会将语句 3 放到语句 4, 5 的后面; 但是要注意语句 1 和 2 的顺序, 语句 4 和 5 的顺序是不做任何保证的

虽然 `volatile` 能够保证可见性和一定程度的有序性，<u>但它并不能保证原子性</u>。如果要保证原子性操作，需要使用 `synchronized` 关键字或者 `java.util.concurrent` 包中提供的原子类。

总之，`volatile` 关键字主要用于保证变量的可见性和禁止指令重排序，但并不能保证原子性。